{% extends "base.html" %}
{% block title %}Modifier un mat√©riel - Inventaire{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">
        <i class="bi bi-pencil-fill text-primary"></i> Modifier ‚Äî {{ materiel.numero_inventaire }}
    </h1>
    <a href="{{ url_for('inventaire') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Retour √† l'inventaire
    </a>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-4">
        <form method="POST" action="{{ url_for('modifier_materiel', mat_id=materiel.id) }}">
            <div class="row g-3">
                <!-- Type de mat√©riel -->
                <div class="col-12 col-md-6">
                    <label class="form-label fw-bold">Type de mat√©riel <span class="text-danger">*</span></label>
                    <select name="type_materiel" id="type_materiel" class="form-select form-select-lg"
                            required onchange="toggleTypeFields()">
                        <option value="">‚Äî Choisir un type ‚Äî</option>
                        {% for cat in categories %}
                        <option value="{{ cat.nom }}" {{ 'selected' if materiel.type_materiel == cat.nom }}>{{ cat.nom }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Num√©ro d'inventaire -->
                <div class="col-12 col-md-6">
                    <label class="form-label fw-bold">Num√©ro d'inventaire</label>
                    <input type="text" name="numero_inventaire" class="form-control form-control-lg"
                           value="{{ materiel.numero_inventaire }}">
                    <small class="text-muted">Facultatif ‚Äî laisser vide pour un identifiant automatique</small>
                </div>

                <!-- Marque -->
                <div class="col-12 col-md-6">
                    <label class="form-label fw-bold">Marque</label>
                    <input type="text" name="marque" class="form-control"
                           value="{{ materiel.marque or '' }}">
                </div>

                <!-- Mod√®le -->
                <div class="col-12 col-md-6">
                    <label class="form-label fw-bold">Mod√®le</label>
                    <input type="text" name="modele" class="form-control"
                           value="{{ materiel.modele or '' }}">
                </div>

                <!-- Num√©ro de s√©rie -->
                <div class="col-12 col-md-6 zone-type-detail" id="zone_numero_serie">
                    <label class="form-label fw-bold">Num√©ro de s√©rie</label>
                    <input type="text" name="numero_serie" class="form-control font-monospace"
                           value="{{ materiel.numero_serie or '' }}">
                </div>

                <!-- Syst√®me d'exploitation -->
                <div class="col-12 col-md-6 zone-type-detail" id="zone_os"
                     style="{{ '' if materiel.type_materiel == 'Ordinateur' else 'display:none' }}">
                    <label class="form-label fw-bold">Syst√®me d'exploitation</label>
                    <select name="systeme_exploitation" class="form-select">
                        <option value="">‚Äî Non renseign√© ‚Äî</option>
                        <option value="Windows 11" {{ 'selected' if materiel.systeme_exploitation == 'Windows 11' }}>Windows 11</option>
                        <option value="Windows 10" {{ 'selected' if materiel.systeme_exploitation == 'Windows 10' }}>Windows 10</option>
                        <option value="macOS" {{ 'selected' if materiel.systeme_exploitation == 'macOS' }}>macOS</option>
                        <option value="Linux" {{ 'selected' if materiel.systeme_exploitation == 'Linux' }}>Linux</option>
                        <option value="Chrome OS" {{ 'selected' if materiel.systeme_exploitation == 'Chrome OS' }}>Chrome OS</option>
                    </select>
                </div>

                <!-- √âtat -->
                <div class="col-12 col-md-6">
                    <label class="form-label fw-bold">√âtat</label>
                    <select name="etat" class="form-select">
                        <option value="disponible" {{ 'selected' if materiel.etat == 'disponible' }}>‚úÖ Disponible</option>
                        <option value="prete" {{ 'selected' if materiel.etat == 'prete' }}>üîÑ En pr√™t</option>
                        <option value="en_panne" {{ 'selected' if materiel.etat == 'en_panne' }}>üîß En panne</option>
                        <option value="reforme" {{ 'selected' if materiel.etat == 'reforme' }}>üóëÔ∏è R√©form√©</option>
                    </select>
                </div>

                <!-- Notes -->
                <div class="col-12">
                    <label class="form-label fw-bold">Notes</label>
                    <textarea name="notes" class="form-control" rows="2">{{ materiel.notes or '' }}</textarea>
                </div>

                <!-- Image du mat√©riel -->
                <div class="col-12">
                    <label class="form-label fw-bold">Image du mat√©riel</label>
                    <input type="hidden" name="image" id="image_selectionnee" value="{{ materiel.image or '' }}">
                    <div class="d-flex align-items-start gap-3">
                        <div id="apercu_image" class="border rounded d-flex align-items-center justify-content-center bg-light"
                             style="width:120px; height:120px; min-width:120px; overflow:hidden;">
                            {% if materiel.image %}
                            <i class="bi bi-image text-muted d-none" style="font-size:2.5rem" id="apercu_placeholder"></i>
                            <img id="apercu_img" src="{{ url_for('static', filename='uploads/materiel/' + materiel.image) }}" alt="" style="width:100%; height:100%; object-fit:cover;">
                            {% else %}
                            <i class="bi bi-image text-muted" style="font-size:2.5rem" id="apercu_placeholder"></i>
                            <img id="apercu_img" src="" alt="" class="d-none" style="width:100%; height:100%; object-fit:cover;">
                            {% endif %}
                        </div>
                        <div class="flex-grow-1">
                            <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="ouvrirGalerie()">
                                <i class="bi bi-images"></i> Choisir dans la biblioth√®que
                            </button>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="text-muted small">ou</span>
                                <label class="btn btn-outline-secondary btn-sm mb-0">
                                    <i class="bi bi-upload"></i> Uploader une nouvelle image
                                    <input type="file" accept="image/*" class="d-none" id="upload_nouvelle_image" onchange="uploadImage(this)">
                                </label>
                            </div>
                            <div id="upload_status" class="small mt-1"></div>
                            <button type="button" class="btn btn-outline-danger btn-sm mt-1 {{ '' if materiel.image else 'd-none' }}" id="btn_retirer_image" onclick="retirerImage()">
                                <i class="bi bi-x-lg"></i> Retirer l'image
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <hr>

            <div class="d-flex gap-3">
                <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                    <i class="bi bi-check-lg"></i> Enregistrer les modifications
                </button>
                <a href="{{ url_for('inventaire') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x-lg"></i> Annuler
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Modal Galerie d'images -->
<div class="modal fade" id="modalGalerie" tabindex="-1" aria-labelledby="modalGalerieLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalGalerieLabel"><i class="bi bi-images"></i> Biblioth√®que d'images</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="galerie_images" class="d-flex flex-wrap gap-2 justify-content-center"></div>
                <div id="galerie_vide" class="text-center text-muted py-4 d-none">
                    <i class="bi bi-image" style="font-size:3rem"></i>
                    <p class="mt-2">Aucune image dans la biblioth√®que.<br>Uploadez-en une avec le bouton ci-dessous.</p>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <label class="btn btn-outline-secondary btn-sm mb-0">
                    <i class="bi bi-upload"></i> Uploader une image
                    <input type="file" accept="image/*" class="d-none" onchange="uploadImageGalerie(this)">
                </label>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<script>
const UPLOAD_URL = '{{ url_for("api_upload_image") }}';
const LIST_URL = '{{ url_for("api_liste_images") }}';
const BASE_IMG_URL = '{{ url_for("static", filename="uploads/materiel/") }}';

function selectionnerImage(filename) {
    document.getElementById('image_selectionnee').value = filename;
    const img = document.getElementById('apercu_img');
    const placeholder = document.getElementById('apercu_placeholder');
    img.src = BASE_IMG_URL + filename;
    img.classList.remove('d-none');
    placeholder.classList.add('d-none');
    document.getElementById('btn_retirer_image').classList.remove('d-none');
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalGalerie'));
    if (modal) modal.hide();
}

function retirerImage() {
    document.getElementById('image_selectionnee').value = '';
    document.getElementById('apercu_img').classList.add('d-none');
    document.getElementById('apercu_placeholder').classList.remove('d-none');
    document.getElementById('btn_retirer_image').classList.add('d-none');
}

function ouvrirGalerie() {
    const galerie = document.getElementById('galerie_images');
    const vide = document.getElementById('galerie_vide');
    galerie.innerHTML = '<div class="text-center w-100 py-3"><div class="spinner-border text-primary"></div></div>';
    vide.classList.add('d-none');

    const modal = new bootstrap.Modal(document.getElementById('modalGalerie'));
    modal.show();

    fetch(LIST_URL)
        .then(r => r.json())
        .then(images => {
            galerie.innerHTML = '';
            if (images.length === 0) {
                vide.classList.remove('d-none');
                return;
            }
            const current = document.getElementById('image_selectionnee').value;
            images.forEach(f => {
                const div = document.createElement('div');
                div.className = 'galerie-item position-relative';
                div.style.cssText = 'width:130px; height:130px; cursor:pointer; border:3px solid transparent; border-radius:8px; overflow:hidden; transition: border-color 0.2s;';
                if (f === current) div.style.borderColor = '#0d6efd';
                div.innerHTML = `<img src="${BASE_IMG_URL}${encodeURIComponent(f)}" style="width:100%; height:100%; object-fit:cover;">
                    <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white text-center small py-1 text-truncate px-1"></div>`;
                div.querySelector('.text-truncate').textContent = f;
                div.onclick = () => selectionnerImage(f);
                div.onmouseenter = () => div.style.borderColor = '#0d6efd';
                div.onmouseleave = () => { if (f !== document.getElementById('image_selectionnee').value) div.style.borderColor = 'transparent'; };
                galerie.appendChild(div);
            });
        });
}

function uploadImage(input) {
    if (!input.files[0]) return;
    const status = document.getElementById('upload_status');
    status.innerHTML = '<span class="text-primary"><i class="bi bi-hourglass-split"></i> Upload en cours...</span>';
    const fd = new FormData();
    fd.append('image', input.files[0]);
    fetch(UPLOAD_URL, { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
            if (data.error) { status.innerHTML = `<span class="text-danger">${data.error}</span>`; return; }
            status.innerHTML = '<span class="text-success"><i class="bi bi-check-lg"></i> Image upload√©e !</span>';
            selectionnerImage(data.filename);
            setTimeout(() => status.innerHTML = '', 3000);
        })
        .catch(() => { status.innerHTML = '<span class="text-danger">Erreur lors de l\'upload</span>'; });
    input.value = '';
}

function uploadImageGalerie(input) {
    if (!input.files[0]) return;
    const fd = new FormData();
    fd.append('image', input.files[0]);
    fetch(UPLOAD_URL, { method: 'POST', body: fd })
        .then(r => r.json())
        .then(data => {
            if (!data.error) ouvrirGalerie();
        });
    input.value = '';
}

function toggleTypeFields() {
    const type = document.getElementById('type_materiel').value.toLowerCase();
    const zoneOS = document.getElementById('zone_os');
    const zoneSerie = document.getElementById('zone_numero_serie');

    // OS uniquement pour les types contenant "ordinateur"
    zoneOS.style.display = type.includes('ordinateur') ? '' : 'none';

    // N¬∞ s√©rie pour √©quipements √©lectroniques
    const typesAvecSerie = ['ordinateur', 'vid√©oprojecteur', 'projecteur', 'tablette', 'imprimante'];
    zoneSerie.style.display = typesAvecSerie.some(t => type.includes(t)) ? '' : 'none';
}
</script>
{% endblock %}
