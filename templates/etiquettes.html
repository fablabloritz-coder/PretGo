{% extends "base.html" %}
{% block title %}Impression d'étiquettes{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">
        <i class="bi bi-printer text-dark"></i> Impression d'étiquettes
        <span class="badge bg-secondary ms-2">{{ comptages.total }}</span>
    </h1>
</div>

<!-- Barre d'actions impression (apparaît quand des items sont cochés) -->
<div id="printBar" class="alert alert-info d-flex align-items-center gap-3 mb-3" style="display:none !important;">
    <i class="bi bi-printer fs-5"></i>
    <span><strong id="printCount">0</strong> étiquette(s) sélectionnée(s)</span>
    <button class="btn btn-primary btn-sm ms-auto" onclick="imprimerSelection()">
        <i class="bi bi-printer"></i> Générer les étiquettes
    </button>
    {% if zebra_active %}
    <button class="btn btn-outline-dark btn-sm" onclick="imprimerZebra()">
        <i class="bi bi-usb-drive"></i> Imprimer Zebra
    </button>
    {% endif %}
    <button class="btn btn-outline-secondary btn-sm" onclick="decocher()">
        <i class="bi bi-x-lg"></i> Tout désélectionner
    </button>
</div>

<!-- Filtres par type -->
<div class="d-flex flex-wrap gap-2 mb-3">
    <a href="{{ url_for('etiquettes') }}"
       class="btn {{ 'btn-dark' if filtre_type == 'tous' else 'btn-outline-dark' }} btn-sm">
        Tous ({{ comptages.total }})
    </a>
    {% for t in types %}
    <a href="{{ url_for('etiquettes', type=t.type_materiel) }}"
       class="btn {{ 'btn-dark' if filtre_type == t.type_materiel else 'btn-outline-dark' }} btn-sm">
        {% if t.type_materiel == 'Ordinateur' %}
            <i class="bi bi-laptop"></i>
        {% elif t.type_materiel == 'Vidéoprojecteur' %}
            <i class="bi bi-projector"></i>
        {% elif t.type_materiel == 'Casque audio' %}
            <i class="bi bi-headset"></i>
        {% else %}
            <i class="bi bi-box"></i>
        {% endif %}
        {{ t.type_materiel }} ({{ comptages.get(t.type_materiel, 0) }})
    </a>
    {% endfor %}
</div>

<!-- Barre de recherche -->
<div class="mb-4">
    <form method="GET" action="{{ url_for('etiquettes') }}" class="d-flex gap-2">
        {% if filtre_type != 'tous' %}
        <input type="hidden" name="type" value="{{ filtre_type }}">
        {% endif %}
        <div class="search-box flex-grow-1">
            <i class="bi bi-search"></i>
            <input type="text" name="q" class="form-control"
                   placeholder="Rechercher par n° inventaire, marque, modèle, n° série..."
                   value="{{ recherche }}">
        </div>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-search"></i>
        </button>
        {% if recherche %}
        <a href="{{ url_for('etiquettes', type=filtre_type if filtre_type != 'tous' else None) }}"
           class="btn btn-outline-secondary">
            <i class="bi bi-x-lg"></i>
        </a>
        {% endif %}
    </form>
</div>

{% if items %}
<div class="table-responsive">
    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th style="width:40px">
                    <input type="checkbox" class="form-check-input" id="checkAll"
                           onchange="toggleAll(this)" title="Tout sélectionner">
                </th>
                <th>N° inventaire</th>
                <th>Type</th>
                <th>Marque / Modèle</th>
                <th>N° série</th>
                <th>État</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr onclick="toggleRow(this, event)" style="cursor:pointer">
                <td>
                    <input type="checkbox" class="form-check-input item-check"
                           value="{{ item.id }}" onchange="majBarreImpression()">
                </td>
                <td>
                    <span class="fw-bold font-monospace">{{ item.numero_inventaire }}</span>
                </td>
                <td>
                    {% if item.type_materiel == 'Ordinateur' %}
                        <i class="bi bi-laptop text-primary"></i>
                    {% elif item.type_materiel == 'Vidéoprojecteur' %}
                        <i class="bi bi-projector text-success"></i>
                    {% elif item.type_materiel == 'Casque audio' %}
                        <i class="bi bi-headset text-warning"></i>
                    {% else %}
                        <i class="bi bi-box text-secondary"></i>
                    {% endif %}
                    {{ item.type_materiel }}
                </td>
                <td>
                    {% if item.marque %}{{ item.marque }}{% endif %}
                    {% if item.modele %}<span class="text-muted">{{ item.modele }}</span>{% endif %}
                    {% if not item.marque and not item.modele %}—{% endif %}
                </td>
                <td>
                    {% if item.numero_serie %}
                        <span class="font-monospace small">{{ item.numero_serie }}</span>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if item.etat == 'disponible' %}
                        <span class="badge bg-success">Disponible</span>
                    {% elif item.etat == 'prete' %}
                        <span class="badge bg-warning">En prêt</span>
                    {% elif item.etat == 'en_panne' %}
                        <span class="badge bg-danger">En panne</span>
                    {% elif item.etat == 'reforme' %}
                        <span class="badge bg-secondary">Réformé</span>
                    {% else %}
                        <span class="badge bg-info">{{ item.etat }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="text-muted small mt-2">
    <i class="bi bi-info-circle"></i> Cliquez sur une ligne pour la sélectionner, ou utilisez les cases à cocher.
</div>
{% else %}
<div class="empty-state">
    <i class="bi bi-printer text-muted" style="font-size: 4rem;"></i>
    <p class="mt-3 fs-5">
        {% if recherche %}
            Aucun matériel trouvé pour "{{ recherche }}"
        {% elif filtre_type != 'tous' %}
            Aucun matériel de type "{{ filtre_type }}"
        {% else %}
            Aucun matériel dans l'inventaire
        {% endif %}
    </p>
</div>
{% endif %}

<script>
function toggleAll(master) {
    document.querySelectorAll('.item-check').forEach(cb => cb.checked = master.checked);
    majBarreImpression();
}

function toggleRow(tr, event) {
    // Ne pas toggler si on clique directement sur la checkbox
    if (event.target.type === 'checkbox') return;
    const cb = tr.querySelector('.item-check');
    cb.checked = !cb.checked;
    majBarreImpression();
}

function majBarreImpression() {
    const checked = document.querySelectorAll('.item-check:checked');
    const bar = document.getElementById('printBar');
    const count = document.getElementById('printCount');
    if (checked.length > 0) {
        bar.style.setProperty('display', 'flex', 'important');
        count.textContent = checked.length;
    } else {
        bar.style.setProperty('display', 'none', 'important');
    }
    // Highlight selected rows
    document.querySelectorAll('.item-check').forEach(cb => {
        cb.closest('tr').classList.toggle('table-primary', cb.checked);
    });
}

function decocher() {
    document.querySelectorAll('.item-check').forEach(cb => cb.checked = false);
    document.getElementById('checkAll').checked = false;
    majBarreImpression();
}

function getSelectedIds() {
    return Array.from(document.querySelectorAll('.item-check:checked')).map(cb => cb.value);
}

function imprimerSelection() {
    const ids = getSelectedIds().join(',');
    if (ids) {
        window.open("{{ url_for('imprimer_etiquettes') }}?ids=" + ids, '_blank');
    }
}

{% if zebra_active %}
function imprimerZebra() {
    const ids = getSelectedIds().map(Number);
    if (!ids.length) return;
    if (!confirm('Envoyer ' + ids.length + ' étiquette(s) à l\'imprimante Zebra ?')) return;

    fetch("{{ url_for('imprimer_zebra') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ids: ids})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert('Erreur : ' + data.error);
        }
    })
    .catch(err => alert('Erreur réseau : ' + err));
}
{% endif %}
</script>
{% endblock %}
