{% extends "base.html" %}
{% block title %}Alertes - Gestion de Prêts{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">
        <i class="bi bi-exclamation-triangle-fill text-danger"></i> Alertes
        {% if alertes %}
        <span class="badge bg-danger ms-2">{{ alertes|length }}</span>
        {% endif %}
    </h1>
    <div class="text-muted">
        Durée par défaut : <strong>{{ duree_defaut }} {{ unite_defaut if unite_defaut else 'jour(s)' }}</strong>
        {% if is_admin %}
        <a href="{{ url_for('admin_reglages') }}" class="btn btn-sm btn-outline-secondary ms-2">
            <i class="bi bi-gear"></i> Modifier
        </a>
        {% endif %}
    </div>
</div>

{% if alertes %}
<div class="alert alert-danger d-flex align-items-center mb-4">
    <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
    <div>
        <strong>{{ alertes|length }} prêt(s) en dépassement !</strong>
        Ces prêts ont dépassé leur durée autorisée.
    </div>
</div>

{% for a in alertes %}
{% set pret = a.pret %}
<div class="alerte-card">
    <div class="alerte-depassement">
        <i class="bi bi-exclamation-octagon-fill"></i>
        +{{ a.depassement_texte }} de dépassement
    </div>
    <div class="pret-header">
        <div>
            <div class="pret-name">{{ pret.nom }} {{ pret.prenom }}</div>
            <span class="cat-badge" style="{{ pret.categorie | style_categorie }}">{{ pret.categorie | label_categorie }}</span>
            {% if pret.classe %}
                <span class="text-muted ms-2">{{ pret.classe }}</span>
            {% endif %}
        </div>
        <div class="text-end">
            <div class="fs-4 fw-bold text-danger">{{ a.depassement_texte }}</div>
            <small class="text-muted">
                Durée : {{ pret | format_duree }}
            </small>
        </div>
    </div>
    <div class="pret-objects">
        <i class="bi bi-box text-danger"></i> {{ pret.descriptif_objets }}
    </div>
    <div class="d-flex justify-content-between align-items-center mt-2">
        <div class="pret-date">
            <i class="bi bi-calendar"></i> Emprunté le {{ pret.date_emprunt | format_date }}
            {% set retour_theo = pret | retour_theorique %}
            {% if retour_theo %}
                <br><i class="bi bi-calendar-event text-warning"></i> Retour prévu : {{ retour_theo }}
            {% endif %}
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('detail_pret', pret_id=pret.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-eye"></i> Détail
            </a>
            <a href="{{ url_for('retour') }}?q={{ pret.nom|urlencode }}" class="btn btn-success btn-lg">
                <i class="bi bi-check-lg"></i> Enregistrer le retour
            </a>
        </div>
    </div>
</div>
{% endfor %}

{% else %}
<div class="empty-state">
    <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
    <p class="mt-3 fs-5">Aucune alerte en cours</p>
    <p class="text-muted">Tous les prêts sont dans les délais autorisés ({{ duree_defaut }} {{ unite_defaut if unite_defaut else 'jour(s)' }} par défaut).</p>
</div>
{% endif %}
{% endblock %}
