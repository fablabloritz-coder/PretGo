{% extends "base.html" %}
{% block title %}Historique - Gestion de Prêts{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">
        <i class="bi bi-clock-history text-primary"></i> Historique des prêts
    </h1>
    <div class="d-flex gap-2">
        <a href="{{ url_for('export_page') }}" class="btn btn-outline-primary">
            <i class="bi bi-download"></i> Exporter en CSV
        </a>
    </div>
</div>

{% if prets %}
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-touch table-hover mb-0">
                <thead>
                    <tr>
                        <th>Statut</th>
                        <th>Emprunteur</th>
                        <th>Catégorie</th>
                        <th>Classe</th>
                        <th>Objet(s)</th>
                        <th>Date emprunt</th>
                        <th>Date retour</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pret in prets %}
                    <tr onclick="window.location='{{ url_for('detail_pret', pret_id=pret.id) }}'" style="cursor:pointer">
                        <td>
                            {% if pret.retour_confirme %}
                                <span class="badge-retourne"><i class="bi bi-check"></i> Retourné</span>
                            {% else %}
                                {% set jours = pret.date_emprunt | jours_ecoules %}
                                {% if jours > 14 %}
                                    <span class="badge-urgent"><i class="bi bi-exclamation-triangle"></i> {{ jours }}j</span>
                                {% elif jours > 7 %}
                                    <span class="badge-actif">{{ jours }}j en cours</span>
                                {% else %}
                                    <span class="badge-actif">En cours</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td><strong>{{ pret.nom }} {{ pret.prenom }}</strong></td>
                        <td><span class="cat-badge" style="{{ pret.categorie | style_categorie }}">{{ pret.categorie | label_categorie }}</span></td>
                        <td>{{ pret.classe or '—' }}</td>
                        <td>{{ pret.descriptif_objets }}</td>
                        <td>{{ pret.date_emprunt | format_date }}</td>
                        <td>{{ pret.date_retour | format_date if pret.date_retour else '—' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="d-flex justify-content-center">
    <ul class="pagination pagination-lg">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('historique', page=page-1) }}">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
            {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('historique', page=p) }}">{{ p }}</a>
            </li>
            {% elif p == 4 or p == total_pages - 3 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('historique', page=page+1) }}">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<div class="text-center text-muted small">
    {{ total }} prêt(s) au total — Page {{ page }} / {{ total_pages }}
</div>

{% else %}
<div class="empty-state">
    <i class="bi bi-clock-history"></i>
    <p>Aucun prêt enregistré pour le moment</p>
    <a href="{{ url_for('nouveau_pret') }}" class="btn btn-primary">
        <i class="bi bi-plus-lg"></i> Enregistrer un premier prêt
    </a>
</div>
{% endif %}
{% endblock %}
