{% extends "base.html" %}
{% block title %}Nouveau Prêt - Gestion de Prêts{% endblock %}

{% block content %}
<h1 class="page-title">
    <i class="bi bi-plus-circle-fill text-primary"></i> Enregistrer un nouveau prêt
</h1>

<div class="card border-0 shadow-sm">
    <div class="card-body p-4">
        <form method="POST" action="{{ url_for('nouveau_pret') }}">
            <input type="hidden" id="personne_id" name="personne_id" value="">

            <!-- Étape 1 : Sélection de la personne -->
            <div class="mb-4">
                <label class="form-label fw-bold fs-5">
                    <i class="bi bi-person-fill text-primary"></i> 1. Qui emprunte ?
                </label>
                <div class="position-relative">
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text"
                               id="personne-search"
                               class="form-control form-control-lg"
                               placeholder="Tapez un nom ou prénom pour rechercher..."
                               autocomplete="off">
                    </div>
                    <div id="autocomplete-results" class="autocomplete-results" style="display:none"></div>
                </div>
                <div id="personne-selected" style="display:none" class="mt-2"></div>
            </div>

            <!-- Étape 2 : Catégorie et description des objets -->
            <div class="mb-4">
                <label class="form-label fw-bold fs-5">
                    <i class="bi bi-box-fill text-primary"></i> 2. Quel(s) objet(s) ?
                </label>

                {% if categories %}
                <div class="mb-3">
                    <label for="categorie_materiel" class="form-label text-muted">
                        <i class="bi bi-tags"></i> Catégorie de matériel
                    </label>
                    <select id="categorie_materiel" name="categorie_materiel" class="form-select form-select-lg">
                        <option value="">— Sélectionnez une catégorie —</option>
                        {% for cat in categories %}
                        <option value="{{ cat.nom }}">{{ cat.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <div class="position-relative">
                    <label for="descriptif_objets" class="form-label text-muted">
                        <i class="bi bi-pencil"></i> Description / Précisions
                    </label>
                    <textarea id="descriptif_objets"
                              name="descriptif_objets"
                              class="form-control form-control-lg"
                              rows="3"
                              placeholder="Tapez un n° d'inventaire, une marque ou un modèle pour rechercher dans le stock, ou saisissez un texte libre..."
                              autocomplete="off"
                              required></textarea>
                    <div id="inventaire-suggestions" class="autocomplete-results" style="display:none"></div>
                </div>

                <!-- Matériel inventorié lié (rempli automatiquement) -->
                <input type="hidden" id="materiel_id" name="materiel_id" value="">
                <div id="materiel-linked" class="mt-2" style="display:none">
                    <div class="alert alert-success py-2 mb-0 d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <span>Matériel inventorié lié : <strong id="materiel-linked-label"></strong></span>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-auto" id="btn-unlink-materiel">
                            <i class="bi bi-x-lg"></i> Délier
                        </button>
                    </div>
                </div>
            </div>

            <!-- Étape 3 : Durée du prêt (optionnel) -->
            <div class="mb-4">
                <label class="form-label fw-bold fs-5">
                    <i class="bi bi-calendar-event-fill text-primary"></i> 3. Durée prévue du prêt (optionnel)
                </label>

                <div class="row g-2 mb-2">
                    <div class="col-auto">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="duree_type"
                                   id="duree_defaut" value="defaut" checked onchange="toggleDuree()">
                            <label class="form-check-label" for="duree_defaut">
                                Par défaut ({{ duree_defaut }} {{ 'heure(s)' if unite_defaut == 'heures' else 'jour(s)' }})
                            </label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="duree_type"
                                   id="duree_type_heures" value="heures" onchange="toggleDuree()">
                            <label class="form-check-label" for="duree_type_heures">Heures</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="duree_type"
                                   id="duree_type_jours" value="jours" onchange="toggleDuree()">
                            <label class="form-check-label" for="duree_type_jours">Jours</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="duree_type"
                                   id="duree_type_fin" value="fin_journee" onchange="toggleDuree()">
                            <label class="form-check-label" for="duree_type_fin">
                                <i class="bi bi-sunset"></i> Fin de journée (17h45)
                            </label>
                        </div>
                    </div>
                </div>

                <div id="zone_heures" style="display:none" class="row align-items-center g-2">
                    <div class="col-auto">
                        <input type="number" name="duree_heures" class="form-control form-control-lg"
                               min="0.5" step="0.5" placeholder="2" style="width: 120px">
                    </div>
                    <div class="col-auto fs-5">heure(s)</div>
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2 mt-1">
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="document.querySelector('[name=duree_heures]').value='1'">1h</button>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="document.querySelector('[name=duree_heures]').value='2'">2h</button>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="document.querySelector('[name=duree_heures]').value='4'">4h</button>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="document.querySelector('[name=duree_heures]').value='8'">8h (1 journée)</button>
                        </div>
                    </div>
                </div>

                <div id="zone_jours" style="display:none" class="row align-items-center g-2">
                    <div class="col-auto">
                        <input type="number" name="duree_jours" class="form-control form-control-lg"
                               min="1" placeholder="7" style="width: 120px">
                    </div>
                    <div class="col-auto fs-5">jour(s)</div>
                </div>

                <div id="zone_fin_journee" style="display:none" class="mt-2">
                    <div class="alert alert-info small py-2 mb-0">
                        <i class="bi bi-sunset"></i>
                        Le prêt sera considéré en dépassement après <strong>17h45 aujourd'hui</strong>.
                    </div>
                </div>
            </div>

            <!-- Étape 4 : Notes (optionnel) -->
            <div class="mb-4">
                <label for="notes" class="form-label fw-bold fs-5">
                    <i class="bi bi-chat-text-fill text-primary"></i> 4. Notes (optionnel)
                </label>
                <input type="text"
                       id="notes"
                       name="notes"
                       class="form-control"
                       placeholder="Informations complémentaires...">
            </div>

            <!-- Date et heure automatiques -->
            <div class="alert alert-info d-flex align-items-center mb-4">
                <i class="bi bi-clock-fill me-2 fs-5"></i>
                <div>
                    <strong>Date et heure d'emprunt :</strong>
                    <span id="date-emprunt-display"></span>
                    <br><small class="text-muted">Enregistrées automatiquement au moment de la validation</small>
                </div>
            </div>

            <!-- Boutons -->
            <div class="d-flex gap-3">
                <button type="button" id="btn-valider-pret" class="btn btn-primary btn-lg flex-grow-1">
                    <i class="bi bi-check-lg"></i> Enregistrer le prêt
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x-lg"></i> Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Modal d'engagement -->
<div class="modal fade" id="modalEngagement" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-shield-check"></i> Engagement de restitution
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-file-earmark-check text-primary" style="font-size: 3rem;"></i>
                <p class="fs-5 mt-3 mb-0">
                    En validant ce prêt, l'emprunteur(euse) s'engage à restituer
                    l'ensemble du matériel confié <strong>dès lors qu'il n'en a plus l'usage</strong>,
                    et ce dans les meilleurs délais.
                </p>
            </div>
            <div class="modal-footer justify-content-center gap-3 border-0 pb-4">
                <button type="button" class="btn btn-outline-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i> Annuler le prêt
                </button>
                <button type="button" id="btn-confirmer-pret" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle-fill"></i> Je m'y engage
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ── Date/heure en temps réel ──
function updateDateTime() {
    const el = document.getElementById('date-emprunt-display');
    if (el) {
        const now = new Date();
        el.textContent = now.toLocaleDateString('fr-FR', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
        });
    }
}
updateDateTime();
setInterval(updateDateTime, 1000);

// ── Toggle durée ──
function toggleDuree() {
    const val = document.querySelector('input[name="duree_type"]:checked').value;
    document.getElementById('zone_heures').style.display = (val === 'heures') ? '' : 'none';
    document.getElementById('zone_jours').style.display = (val === 'jours') ? '' : 'none';
    document.getElementById('zone_fin_journee').style.display = (val === 'fin_journee') ? '' : 'none';
}

// ── Autocomplete inventaire sur la description ──
(function() {
    const textarea = document.getElementById('descriptif_objets');
    const suggestionsBox = document.getElementById('inventaire-suggestions');
    const materielIdInput = document.getElementById('materiel_id');
    const linkedBox = document.getElementById('materiel-linked');
    const linkedLabel = document.getElementById('materiel-linked-label');
    const btnUnlink = document.getElementById('btn-unlink-materiel');
    let debounceTimer = null;

    if (!textarea || !suggestionsBox) return;

    textarea.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        // Rechercher sur le dernier segment (après la dernière virgule ou retour à la ligne)
        const val = this.value;
        const lastSep = Math.max(val.lastIndexOf(','), val.lastIndexOf('\n'));
        const segment = (lastSep >= 0 ? val.substring(lastSep + 1) : val).trim();
        if (segment.length < 2) {
            suggestionsBox.style.display = 'none';
            return;
        }
        debounceTimer = setTimeout(() => rechercherInventaire(segment), 300);
    });

    // Fermer les suggestions si on clique ailleurs
    document.addEventListener('click', function(e) {
        if (!textarea.contains(e.target) && !suggestionsBox.contains(e.target)) {
            suggestionsBox.style.display = 'none';
        }
    });

    // Bouton délier
    if (btnUnlink) {
        btnUnlink.addEventListener('click', function() {
            unlinkMateriel();
            textarea.value = '';
            textarea.focus();
        });
    }

    function unlinkMateriel() {
        if (materielIdInput) materielIdInput.value = '';
        if (linkedBox) linkedBox.style.display = 'none';
    }

    function linkMateriel(id, label) {
        if (materielIdInput) materielIdInput.value = id;
        if (linkedLabel) linkedLabel.textContent = label;
        if (linkedBox) linkedBox.style.display = 'block';
    }

    function rechercherInventaire(query) {
        fetch('{{ url_for("api_inventaire") }}?q=' + encodeURIComponent(query))
            .then(r => r.json())
            .then(items => {
                if (items.length === 0) {
                    suggestionsBox.style.display = 'none';
                    return;
                }
                suggestionsBox.innerHTML = '';
                items.forEach(item => {
                    // Construire un label lisible
                    let label = item.type_materiel;
                    if (item.marque) label += ' — ' + item.marque;
                    if (item.modele) label += ' ' + item.modele;
                    // Ajouter le n° inventaire seulement s'il n'est pas auto-généré
                    if (item.numero_inventaire && !item.numero_inventaire.startsWith('AUTO-')) {
                        label += ' (' + item.numero_inventaire + ')';
                    }
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item d-flex align-items-center gap-2';
                    // Miniature si image disponible
                    if (item.image) {
                        const img = document.createElement('img');
                        img.src = '{{ url_for("static", filename="uploads/materiel/") }}' + encodeURIComponent(item.image);
                        img.style.cssText = 'width:35px; height:35px; object-fit:cover; border-radius:4px; min-width:35px;';
                        div.appendChild(img);
                    } else {
                        const icon = document.createElement('i');
                        icon.className = 'bi bi-pc-display text-primary';
                        icon.style.cssText = 'font-size:1.2rem; min-width:30px; text-align:center;';
                        div.appendChild(icon);
                    }
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'flex-grow-1';
                    labelSpan.textContent = label;
                    div.appendChild(labelSpan);
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-success';
                    badge.textContent = 'Inventaire';
                    div.appendChild(badge);
                    div.addEventListener('click', function() {
                        // Remplacer uniquement le dernier segment par le label du matériel
                        const cur = textarea.value;
                        const lastSep = Math.max(cur.lastIndexOf(','), cur.lastIndexOf('\n'));
                        if (lastSep >= 0) {
                            textarea.value = cur.substring(0, lastSep + 1) + ' ' + label;
                        } else {
                            textarea.value = label;
                        }
                        suggestionsBox.style.display = 'none';
                        linkMateriel(item.id, label);
                        textarea.focus();
                    });
                    suggestionsBox.appendChild(div);
                });
                suggestionsBox.style.display = 'block';
            })
            .catch(() => { suggestionsBox.style.display = 'none'; });
    }
})();

// ── Modal d'engagement avant soumission ──
(function() {
    const btnValider = document.getElementById('btn-valider-pret');
    const btnConfirmer = document.getElementById('btn-confirmer-pret');
    const form = document.querySelector('form[action]');

    if (!btnValider || !btnConfirmer || !form) return;

    btnValider.addEventListener('click', function() {
        // Vérifications basiques avant d'ouvrir la modal
        const personneId = document.getElementById('personne_id').value;
        const descriptif = document.getElementById('descriptif_objets').value.trim();

        if (!personneId) {
            alert('Veuillez sélectionner une personne.');
            return;
        }
        if (!descriptif) {
            alert('Veuillez décrire le(s) objet(s) emprunté(s).');
            return;
        }

        // Ouvrir la modal d'engagement
        const modal = new bootstrap.Modal(document.getElementById('modalEngagement'));
        modal.show();
    });

    btnConfirmer.addEventListener('click', function() {
        form.submit();
    });
})();
</script>
{% endblock %}
