{% extends "base.html" %}
{% block title %}Modifier le prêt #{{ pret.id }} - PretGo{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">
        <i class="bi bi-pencil-square text-warning"></i> Modifier le prêt #{{ pret.id }}
    </h1>
    <a href="{{ url_for('detail_pret', pret_id=pret.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Retour au détail
    </a>
</div>

<div class="alert alert-warning d-flex align-items-center mb-4">
    <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
    <div>
        <strong>Modification d'un prêt en cours.</strong>
        La date et l'heure de cette modification seront enregistrées automatiquement.
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-4">
        <form method="POST" action="{{ url_for('modifier_pret', pret_id=pret.id) }}" id="formModifierPret">
            <input type="hidden" id="personne_id" name="personne_id" value="{{ pret.personne_id }}">

            <!-- Étape 1 : Sélection de la personne -->
            <div class="mb-4">
                <label class="form-label fw-bold fs-5">
                    <i class="bi bi-person-fill text-primary"></i> 1. Qui emprunte ?
                </label>
                <div class="position-relative">
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text"
                               id="personne-search"
                               class="form-control form-control-lg"
                               placeholder="Tapez un nom ou prénom pour rechercher..."
                               autocomplete="off"
                               value="{{ pret.nom }} {{ pret.prenom }}">
                    </div>
                    <div id="autocomplete-results" class="autocomplete-results" style="display:none"></div>
                </div>
                <div id="personne-selected" class="mt-2">
                    <div class="alert alert-success py-2 mb-0 d-flex align-items-center">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <span><strong>{{ pret.nom }} {{ pret.prenom }}</strong>
                            <span class="cat-badge ms-2" style="{{ pret.categorie | style_categorie }}">{{ pret.categorie | label_categorie }}</span>
                            {% if pret.classe %}<small class="text-muted ms-1">({{ pret.classe }})</small>{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Étape 2 : Objets empruntés (multi-matériel) -->
            <div class="mb-4">
                <label class="form-label fw-bold fs-5">
                    <i class="bi bi-box-fill text-primary"></i> 2. Quel(s) objet(s) ?
                </label>
                <p class="text-muted small mb-2">
                    Ajoutez un ou plusieurs objets. Tapez pour chercher dans l'inventaire, ou saisissez un texte libre.
                </p>

                <div id="items-container">
                    {% if pret_items %}
                        {% for item in pret_items %}
                        <div class="item-row mb-2 position-relative" data-index="{{ loop.index0 }}">
                            <div class="input-group">
                                <input type="text"
                                       name="items_description[]"
                                       class="form-control form-control-lg item-input"
                                       placeholder="N° inventaire, marque, modèle ou texte libre..."
                                       autocomplete="off"
                                       value="{{ item.description }}"
                                       required>
                                <input type="hidden" name="items_materiel_id[]" class="item-materiel-id" value="{{ item.materiel_id or '' }}">
                                {% if mode_scanner != 'douchette' %}
                                <button type="button" class="btn btn-outline-info btn-scan-item" title="Scanner un code-barres">
                                    <i class="bi bi-upc-scan"></i>
                                </button>
                                {% endif %}
                                <button type="button" class="btn btn-outline-danger btn-remove-item" title="Retirer" {% if pret_items | length <= 1 %}style="display:none"{% endif %}>
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <div class="item-linked mt-1" {% if not item.materiel_id %}style="display:none"{% endif %}>
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> <span class="linked-label">{{ item.numero_inventaire or '' }}</span></span>
                                <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-1 btn-unlink-item">délier</button>
                            </div>
                            <div class="item-suggestions autocomplete-results" style="display:none"></div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <!-- Fallback : pré-remplir avec le descriptif existant -->
                        <div class="item-row mb-2 position-relative" data-index="0">
                            <div class="input-group">
                                <input type="text"
                                       name="items_description[]"
                                       class="form-control form-control-lg item-input"
                                       placeholder="N° inventaire, marque, modèle ou texte libre..."
                                       autocomplete="off"
                                       value="{{ pret.descriptif_objets }}"
                                       required>
                                <input type="hidden" name="items_materiel_id[]" class="item-materiel-id" value="{{ pret.materiel_id or '' }}">
                                {% if mode_scanner != 'douchette' %}
                                <button type="button" class="btn btn-outline-info btn-scan-item" title="Scanner un code-barres">
                                    <i class="bi bi-upc-scan"></i>
                                </button>
                                {% endif %}
                                <button type="button" class="btn btn-outline-danger btn-remove-item" title="Retirer" style="display:none">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                            <div class="item-linked mt-1" {% if not pret.materiel_id %}style="display:none"{% endif %}>
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> <span class="linked-label">Matériel #{{ pret.materiel_id }}</span></span>
                                <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-1 btn-unlink-item">délier</button>
                            </div>
                            <div class="item-suggestions autocomplete-results" style="display:none"></div>
                        </div>
                    {% endif %}
                </div>

                <button type="button" id="btn-add-item" class="btn btn-outline-primary btn-sm mt-2">
                    <i class="bi bi-plus-circle"></i> Ajouter un objet
                </button>
            </div>

            <!-- Lieu (optionnel) -->
            {% if lieux %}
            <div class="mb-4">
                <label class="form-label fw-bold fs-5">
                    <i class="bi bi-geo-alt-fill text-primary"></i> 3. Lieu de prêt (optionnel)
                </label>
                <select name="lieu_id" class="form-select">
                    <option value="">— Aucun lieu spécifié —</option>
                    {% for lieu in lieux %}
                    <option value="{{ lieu.id }}" {% if pret.lieu_id == lieu.id %}selected{% endif %}>{{ lieu.nom }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <!-- Durée du prêt -->
            <div class="mb-4">
                <label class="form-label fw-bold fs-5">
                    <i class="bi bi-calendar-event-fill text-primary"></i> {{ '4' if lieux else '3' }}. Durée prévue du prêt
                </label>

                {# Rétrocompatibilité : si type_duree n'existe pas (anciens prêts), on déduit le type #}
                {% set effective_type = pret.type_duree or ('heures' if pret.duree_pret_heures else ('jours' if pret.duree_pret_jours else 'defaut')) %}
                <div class="row g-2 mb-2">
                    <div class="col-auto">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="duree_type"
                                   id="duree_defaut" value="defaut"
                                   {% if effective_type == 'defaut' %}checked{% endif %}
                                   onchange="toggleDuree()">
                            <label class="form-check-label" for="duree_defaut">
                                Par défaut ({{ duree_defaut }} {{ 'heure(s)' if unite_defaut == 'heures' else 'jour(s)' }})
                            </label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="duree_type"
                                   id="duree_type_heures" value="heures"
                                   {% if effective_type == 'heures' %}checked{% endif %}
                                   onchange="toggleDuree()">
                            <label class="form-check-label" for="duree_type_heures">Heures</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="duree_type"
                                   id="duree_type_jours" value="jours"
                                   {% if effective_type == 'jours' %}checked{% endif %}
                                   onchange="toggleDuree()">
                            <label class="form-check-label" for="duree_type_jours">Jours</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="duree_type"
                                   id="duree_type_fin" value="fin_journee"
                                   {% if effective_type == 'fin_journee' %}checked{% endif %}
                                   onchange="toggleDuree()">
                            <label class="form-check-label" for="duree_type_fin">
                                <i class="bi bi-sunset"></i> Fin de journée ({{ heure_fin_journee | replace(':', 'h') }})
                            </label>
                        </div>
                    </div>
                </div>

                <div id="zone_heures" {% if effective_type != 'heures' %}style="display:none"{% endif %} class="row align-items-center g-2">
                    <div class="col-auto">
                        <input type="number" name="duree_heures" class="form-control form-control-lg"
                               min="0.5" step="0.5" placeholder="2" style="width: 120px"
                               value="{{ pret.duree_pret_heures or '' if effective_type == 'heures' else '' }}">
                    </div>
                    <div class="col-auto fs-5">heure(s)</div>
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-2 mt-1">
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="document.querySelector('[name=duree_heures]').value='1'">1h</button>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="document.querySelector('[name=duree_heures]').value='2'">2h</button>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="document.querySelector('[name=duree_heures]').value='4'">4h</button>
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    onclick="document.querySelector('[name=duree_heures]').value='8'">8h (1 journée)</button>
                        </div>
                    </div>
                </div>

                <div id="zone_jours" {% if effective_type != 'jours' %}style="display:none"{% endif %} class="row align-items-center g-2">
                    <div class="col-auto">
                        <input type="number" name="duree_jours" class="form-control form-control-lg"
                               min="1" placeholder="7" style="width: 120px"
                               value="{{ pret.duree_pret_jours or '' }}">
                    </div>
                    <div class="col-auto fs-5">jour(s)</div>
                </div>

                <div id="zone_fin_journee" {% if effective_type != 'fin_journee' %}style="display:none"{% endif %} class="mt-2">
                    <div class="alert alert-info small py-2 mb-0">
                        <i class="bi bi-sunset"></i>
                        Le prêt sera considéré en dépassement après <strong>{{ heure_fin_journee | replace(':', 'h') }} aujourd'hui</strong>.
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
                <label for="notes" class="form-label fw-bold fs-5">
                    <i class="bi bi-chat-text-fill text-primary"></i> {{ '5' if lieux else '4' }}. Notes (optionnel)
                </label>
                <input type="text"
                       id="notes"
                       name="notes"
                       class="form-control"
                       placeholder="Informations complémentaires..."
                       value="{{ pret.notes or '' }}">
            </div>

            <!-- Info prêt original -->
            <div class="alert alert-secondary d-flex align-items-center mb-4">
                <i class="bi bi-info-circle-fill me-2 fs-5"></i>
                <div>
                    <strong>Prêt original :</strong> enregistré le {{ pret.date_emprunt | format_date }}
                    {% if pret.date_modification %}
                    <br><small class="text-muted"><i class="bi bi-pencil"></i> Dernière modification : {{ pret.date_modification | format_date }}</small>
                    {% endif %}
                </div>
            </div>

            <!-- Boutons -->
            <div class="d-flex gap-3">
                <button type="submit" class="btn btn-warning btn-lg flex-grow-1">
                    <i class="bi bi-check-lg"></i> Enregistrer les modifications
                </button>
                <a href="{{ url_for('detail_pret', pret_id=pret.id) }}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x-lg"></i> Annuler
                </a>
            </div>
        </form>
    </div>
</div>

{% if mode_scanner != 'douchette' %}
<!-- Modal Scanner -->
<div class="modal fade" id="modalScanner" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-upc-scan"></i> Scanner un code-barres</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scanner-reader" style="width:100%"></div>
                <p class="text-muted text-center small mt-2">Placez le code-barres devant la caméra</p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if mode_scanner != 'douchette' %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
{% endif %}
<script>
function toggleDuree() {
    const val = document.querySelector('input[name="duree_type"]:checked').value;
    document.getElementById('zone_heures').style.display = (val === 'heures') ? '' : 'none';
    document.getElementById('zone_jours').style.display = (val === 'jours') ? '' : 'none';
    document.getElementById('zone_fin_journee').style.display = (val === 'fin_journee') ? '' : 'none';
}

// ══════════════════════════════════════
//  MULTI-MATÉRIEL : gestion des items
// ══════════════════════════════════════
(function() {
    const container = document.getElementById('items-container');
    const btnAdd = document.getElementById('btn-add-item');
    let itemIndex = container.querySelectorAll('.item-row').length;
    let debounceTimers = {};
    let activeScanTarget = null;
    let html5QrCode = null;

    function updateRemoveButtons() {
        const rows = container.querySelectorAll('.item-row');
        rows.forEach(row => {
            row.querySelector('.btn-remove-item').style.display = rows.length > 1 ? '' : 'none';
        });
    }

    btnAdd.addEventListener('click', function() {
        const row = document.createElement('div');
        row.className = 'item-row mb-2 position-relative';
        row.dataset.index = itemIndex;
        row.innerHTML = `
            <div class="input-group">
                <input type="text" name="items_description[]"
                       class="form-control form-control-lg item-input"
                       placeholder="N° inventaire, marque, modèle ou texte libre..."
                       autocomplete="off" required>
                <input type="hidden" name="items_materiel_id[]" class="item-materiel-id" value="">
                {% if mode_scanner != 'douchette' %}
                <button type="button" class="btn btn-outline-info btn-scan-item" title="Scanner">
                    <i class="bi bi-upc-scan"></i>
                </button>
                {% endif %}
                <button type="button" class="btn btn-outline-danger btn-remove-item" title="Retirer">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="item-linked mt-1" style="display:none">
                <span class="badge bg-success"><i class="bi bi-check-circle"></i> <span class="linked-label"></span></span>
                <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-1 btn-unlink-item">délier</button>
            </div>
            <div class="item-suggestions autocomplete-results" style="display:none"></div>
        `;
        container.appendChild(row);
        itemIndex++;
        updateRemoveButtons();
        row.querySelector('.item-input').focus();
    });

    container.addEventListener('click', function(e) {
        if (e.target.closest('.btn-remove-item')) {
            e.target.closest('.item-row').remove();
            updateRemoveButtons();
        }
        if (e.target.closest('.btn-unlink-item')) {
            const row = e.target.closest('.item-row');
            row.querySelector('.item-materiel-id').value = '';
            row.querySelector('.item-linked').style.display = 'none';
        }
        if (e.target.closest('.btn-scan-item')) {
            activeScanTarget = e.target.closest('.item-row');
            openScanner();
        }
    });

    container.addEventListener('input', function(e) {
        if (!e.target.classList.contains('item-input')) return;
        const row = e.target.closest('.item-row');
        const idx = row.dataset.index;
        row.querySelector('.item-materiel-id').value = '';
        row.querySelector('.item-linked').style.display = 'none';
        clearTimeout(debounceTimers[idx]);
        const val = e.target.value.trim();
        if (val.length < 2) { row.querySelector('.item-suggestions').style.display = 'none'; return; }
        debounceTimers[idx] = setTimeout(() => searchInventaire(row, val), 300);
    });

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.item-row')) {
            container.querySelectorAll('.item-suggestions').forEach(s => s.style.display = 'none');
        }
    });

    // Intercepter Entrée sur les champs item (évite soumission du form + recherche immédiate)
    container.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.classList.contains('item-input')) {
            e.preventDefault();
            const row = e.target.closest('.item-row');
            const val = e.target.value.trim();
            if (val.length >= 2) searchInventaire(row, val);
        }
    });

    function searchInventaire(row, query) {
        fetch('{{ url_for("api_inventaire") }}?q=' + encodeURIComponent(query))
            .then(r => r.json())
            .then(items => {
                const box = row.querySelector('.item-suggestions');
                if (!items.length) { box.style.display = 'none'; return; }
                box.innerHTML = '';
                items.forEach(item => {
                    let label = item.type_materiel;
                    if (item.marque) label += ' — ' + item.marque;
                    if (item.modele) label += ' ' + item.modele;
                    if (item.numero_inventaire && !item.numero_inventaire.startsWith('AUTO-'))
                        label += ' (' + item.numero_inventaire + ')';
                    const div = document.createElement('div');
                    div.className = 'autocomplete-item d-flex align-items-center gap-2';
                    if (item.image) {
                        const img = document.createElement('img');
                        img.src = '{{ url_for("static", filename="uploads/materiel/") }}' + encodeURIComponent(item.image);
                        img.style.cssText = 'width:35px;height:35px;object-fit:cover;border-radius:4px;';
                        div.appendChild(img);
                    } else {
                        const ic = document.createElement('i');
                        ic.className = 'bi bi-pc-display text-primary';
                        ic.style.cssText = 'font-size:1.2rem;min-width:30px;text-align:center;';
                        div.appendChild(ic);
                    }
                    const sp = document.createElement('span');
                    sp.className = 'flex-grow-1'; sp.textContent = label;
                    div.appendChild(sp);
                    const bd = document.createElement('span');
                    bd.className = 'badge ' + (item.etat === 'disponible' ? 'bg-success' : 'bg-secondary');
                    bd.textContent = item.etat === 'disponible' ? 'Disponible' : item.etat;
                    div.appendChild(bd);
                    div.addEventListener('click', () => {
                        row.querySelector('.item-input').value = label;
                        row.querySelector('.item-materiel-id').value = item.id;
                        row.querySelector('.linked-label').textContent = item.numero_inventaire || label;
                        row.querySelector('.item-linked').style.display = 'block';
                        box.style.display = 'none';
                    });
                    box.appendChild(div);
                });
                box.style.display = 'block';
            }).catch(() => {});
    }

    {% if mode_scanner != 'douchette' %}
    function openScanner() {
        const modal = new bootstrap.Modal(document.getElementById('modalScanner'));
        modal.show();
        setTimeout(() => {
            if (html5QrCode) try { html5QrCode.stop(); } catch(e) {}
            html5QrCode = new Html5Qrcode("scanner-reader");
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 100 } },
                (decoded) => {
                    html5QrCode.stop().then(() => {
                        modal.hide();
                        if (activeScanTarget) {
                            const inp = activeScanTarget.querySelector('.item-input');
                            inp.value = decoded;
                            inp.dispatchEvent(new Event('input'));
                        }
                    });
                }, () => {}
            ).catch(err => {
                document.getElementById('scanner-reader').innerHTML =
                    '<div class="alert alert-warning text-center"><i class="bi bi-camera-video-off"></i> Caméra non disponible<br><small>' + err + '</small></div>';
            });
        }, 500);
    }

    document.getElementById('modalScanner').addEventListener('hidden.bs.modal', function() {
        if (html5QrCode) try { html5QrCode.stop(); } catch(e) {}
    });
    {% endif %}
})();
</script>
{% endblock %}
